= Asciidoctor uses Arquillian and Docker to easily ensure that AsciidoctorJ works into WildFly AS
Maxime Greau <greau.maxime@gmail.com>
v1.0, March 01, 2015: First English version
:awestruct-layout: post
:awestruct-tags: [asciidoctor, docker, wildfly, arquillian]
:toc2:
:toc-placement: preamble
:toc-title: Table of Contents
:toclevels: 4
:source-highlighter: coderay
:linkattrs:
:sectanchors:
:sectlink:
:experimental:
:mdash: &#8212;
:language: asciidoc
:includedir: _includes
:icons: font
:imagesdir: ./images/
//Refs
:link-devnation-talk: http://www.devnation.org/2014/#websocketAsciidoctor
:link-devnation-bof: http://www.devnation.org/2014/#bofWildfly8
:link-asciidoctorj-pr: https://github.com/asciidoctor/asciidoctorj/pull/118
:link-asciidoctorj-bug: https://github.com/asciidoctor/asciidoctorj/issues/102
:link-asciidoctor-discuss: http://discuss.asciidoctor.org/AsciidoctorJ-1-5-and-Java-EE-td1651.html
:uri-asciidoctor: http://asciidoctor.org
:uri-asciidoctor-list: http://discuss.asciidoctor.org/
:uri-asciidoctor-dockerhub: https://registry.hub.docker.com/repos/asciidoctor/
:uti-asciidoctor-processor-diagram: https://github.com/mojavelinux/decks/blob/master/discover-zen-writing-asciidoc/images/asciidoc-processor.png
:uri-asciidoctorj: https://github.com/asciidoctor/asciidoctorj
:uri-asciidoctorj-processor-diagram: https://raw.githubusercontent.com/mgreau/slides/master/websocket-asciidoctor/NantesJUG/images/asciidoctor-java.png
:uri-asciidoctorj-doc: http://asciidoctor.org/docs/asciidoctorj/
:uri-docker-asciidoctorj-github: http://github.com/asciidoctor/docker-asciidoctorj
:uri-asciidoctor-docker-hub: https://registry.hub.docker.com/repos/asciidoctor/
:uri-asciidoctor: http://asciidoctor.org
:uri-arquillian-cube-github: https://github.com/arquillian/arquillian-cube
:uri-jboss-wildfly-docker: https://registry.hub.docker.com/u/jboss/wildfly/
:uri-docker: http://docker.com
:uri-asciidoctorj-wildflyas-install: http://asciidoctor.org/docs/asciidoctorj/#running-asciidoctorj-on-wildfly-as
:uri-twitter-dan-allen: http://twitter.com/mojavelinux
:uri-twitter-alex-sotob: http://twitter.com/alexsotob
:uri-twitter-guillaume-scheibel: http://twitter.com/g_scheibel

TIP: Language *_EN_* /  Timereading *_10 mn_*

[NOTE]
.Overview
====
This post explains how we execute Arquillian tests into a Docker container, so we'll talk about :

* {uri-docker-asciidoctorj-github}[docker-asciidoctorj], the dedicated project on Asciidoctor organization
* {uri-asciidoctor-dockerhub}[the Asciidoctor organization on Docker Hub],
* {uri-arquillian-cube-github}[Arquillian Cube], the Arquillian extension that can be used to manager Docker containers from Arquillian.
* {uri-jboss-wildfly-docker}[the WildFly docker image] from JBoss
====

It's been a while since I wrote here but like many technicals blogger (I guess), I've a lot of blog posts on draft mode. And I've a lot to write about 2014 which was
an *AMAZING year* : indeed, thanks to the {uri-asciidoctor}[*Asciidoctor project*] and +Java EE 7 / WildFly+ technologies, I gave *2 talks* at {link-devnation-talk}[+DevNation, San Francisco+] to speak about Open Source projects :)  +
But I'll blog about this +awesome experience+ soon.

*So what this post is about : Docker ? Asciidoctor ? Arquillian ?*

[[docker_arquillian_asciidoctor]]
.The power of Arquillian & Docker for AsciidoctorJ integration tests
image::docker-arquillian-asciidoctor.png[AsciidoctorJ Docker containers managed by Arquillian,750]

You've just read the title and you said : +

- _"Oh no ! Not another post about Docker!"_,

and I want to answer +

- _"Well, it's 2015, is it possible to write a blog post without mentionning Docker ?_" +

To be serious, it's more a blog post about the {uri-asciidoctorj}[AsciidoctorJ] project and how {uri-docker}[Docker] helps us to easily check that AsciidoctorJ can be execute into a *Java EE application server* like *WildFly*. +
So it's not a post about Docker itself but more a use case where Docker is the key to the ease of tests...OK you're right, it's about Docker :)

pass::[more]

== Asciidoctor on the JVM with AsciidoctorJ

I guess that I don't need to introduce {uri-asciidoctor}[*Asciidoctor*] now that it became so popular since it's was started by {uri-twitter-dan-allen}[*Dan Allen*] at the end of 2012. +
Well, if you don't know, Asciidoctor is a *fast text processor* and *publishing toolchain* for *converting* +*AsciiDoc*+ content to *HTML5*, *PDF*, *DocBook 5* (or 4.5) and other formats.
Asciidoctor is written in Ruby, packaged as a RubyGem and published to RubyGems.org.

[[asciidoctor_processor]]
.Asciidoctor convert AsciiDoc files to several formats
image::{uri-asciidoctor-processor-diagram}[Diagram showing output files that Asciidoctor can generate ,750]


*AsciidoctorJ* is the official library for running +Asciidoctor on the JVM+.
Using AsciidoctorJ, you can convert AsciiDoc content or analyze the structure of a parsed AsciiDoc document from *Java* and *other JVM languages*.


[[asciidoctorj_jvm]]
.Asciidoctor on the JVM with AsciidoctorJ
image::{uri-asciidoctorj-processor-diagram}[Diagram which explains how AsciidoctorJ makes Asciidoctor works on the JVM,750]

== AsciidoctorJ in a Java application server ?

So here we have a problem
The problem is that if you want to include AsciidoctorJ in your Java application, it doesn't work. Indeed, AsciidoctorJ is base on JRUby and
there are some classloader troubles with JRuby see PR118,  Bug 102 and this thread on the asciidoctor discussions list.
JRuby noticing that "asciidoctor gem is not available"

=== How do we make it works

We tried

=== Make it easy thanks to the power of Arquillian & Docker

OK so we have a solution but there are several manual steps to follow in order to have

==== Arquillian Cube extension to the rescue !

Arquillian Cube is a very cool project developed by Alex Soto and the Arquillian community
TODO => schema


==== Docker AsciidoctorJ project in details



The project layout is as follows :

[[eg5-callouts]]
.project structure
====
[source, text]
----
+ dockerfiles
   |+ wildfly82
      |- Dockerfile   // <1>
+ src/main/java
   |+ org.asciidoctor
      |- AsciidoctorProcessor.java    // <2>
      |- ConverterServlet.java   // <3>
+ src/main/resources
   |+ adoc
      |- sample.adoc   // <4>
+ src/test/java
   |+ org.asciidoctor
      |- ConverterServletTest.java   // <5>
+ src/test/resources
   |+ wildfly
      |- MANIFEST.MF   // <6>
   |- arquillian.xml   // <7>
pom.xml
----
<1> Dockerfile to build Docker image with AsciidoctorJ into WildFly 8.2
<2> Java Bean which convert AsciiDoc file into HTML or PDf file
<3> Java Servlet which used the converter
<4> Sample AsciiDoc file to convert
<5> Tests to process AsciiDoc to HTML/PDF with AsciidoctorJ
<6> MANIFEST file used to depend on AsciidoctorJ WilFly AS module
<7> Arquillian XML file to configure Docker containers
====


[[eg1-callouts]]
.Dockerfile
====
[source, text]
----
FROM jboss/wildfly:8.2.0.Final   // <1>
MAINTAINER Maxime Gr√©au <greau.maxime@gmail.com>

# Create a WildFly admin user to deploy app with CLI
RUN /opt/jboss/wildfly/bin/add-user.sh -up mgmt-users.properties admin Admin#70365 --silent  // <2>

# Set env variables for versions // <3>
ENV ASCIIDOCTORJ_VERSION 1.5.2
ENV ASCIIDOCTORJ_PDF_VERSION 1.5.0-alpha.6
ENV ASCIIDOCTORJ_EPUB3_VERSION 1.5.0-alpha.4
ENV JRUBY_VERSION 1.7.16.1

# Handle asciidoctor-backends // <4>
ENV ASCIIDOCTOR_BACKENDS /opt/jboss/asciidoctor-backends
RUN mkdir -p ${ASCIIDOCTOR_BACKENDS}

# Create the AsciidoctorJ module // <5>
RUN mkdir -p ${JBOSS_HOME}/modules/org/asciidoctor/main
ENV ASCIIDOCTORJ_MODULE /opt/jboss/wildfly/modules/org/asciidoctor/main

# Output directory to store generated files
ENV OUTPUT_DIRECTORY /tmp

# Set the URL_BASE env variable to download artifacts
ENV URL_BASE https://repo1.maven.org/maven2/

ADD module.xml ${ASCIIDOCTORJ_MODULE}/module.xml // <6>

RUN cd ${ASCIIDOCTORJ_MODULE} \
&& curl -O ${URL_BASE}org/asciidoctor/asciidoctorj/${ASCIIDOCTORJ_VERSION}/asciidoctorj-${ASCIIDOCTORJ_VERSION}.jar \
&& curl -O ${URL_BASE}org/asciidoctor/asciidoctorj-pdf/${ASCIIDOCTORJ_PDF_VERSION}/asciidoctorj-pdf-${ASCIIDOCTORJ_PDF_VERSION}.jar \
&& curl -O ${URL_BASE}org/asciidoctor/asciidoctorj-epub3/${ASCIIDOCTORJ_EPUB3_VERSION}/asciidoctorj-epub3-${ASCIIDOCTORJ_EPUB3_VERSION}.jar \
&& curl -O -m 900 ${URL_BASE}org/jruby/jruby-complete/${JRUBY_VERSION}/jruby-complete-${JRUBY_VERSION}.jar \
\
&& (curl -LkSs https://api.github.com/repos/asciidoctor/asciidoctor-backends/tarball | tar xfz - -C ${ASCIIDOCTOR_BACKENDS} --strip-components=1)

WORKDIR ${OUTPUT_DIRECTORY}
VOLUME ${OUTPUT_DIRECTORY}

CMD ["/opt/jboss/wildfly/bin/standalone.sh", "-b", "0.0.0.0", "-bmanagement", "0.0.0.0"]
----
<1> start with the WildFly JBoss image
<2> TODO
<3> TODO
<4> TODO
<5> TODO
<6> TODO
====

TODO => exemple code

===== Used the Docker image from a registry (remote or local)

. How to build the Docker image with docker command :
.. Clone this project :

 $ git clone https://github.com/mgreau/docker-asciidoctorj.git

.. Build the Docker image

  cd docker-asciidoctorj
  docker build -t asciidoctor/asciidoctorj-wildfly82 dockerfiles/wildfly82/

[[eg2-callouts]]
.Docker images
====
[source, text]
----
mgreau@mgreau-osxubuntu:~/git/asciidoctor/docker-asciidoctorj$ sudo docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
mgreau@mgreau-osxubuntu:~/git/asciidoctor/docker-asciidoctorj$ sudo docker images
REPOSITORY                                TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
asciidoctor/asciidoctorj-wildfly82        latest              80e19c9457fc        2 minutes ago       982.5 MB
jboss/wildfly                             8.2.0.Final         24c5b96027df        3 months ago        951.3 MB
---
====

. How to execute the Arquillian Tests using an existing Docker image
.. Ensure Java, Maven and Docker are installed, and that the Docker image *asciidoctor/asciidoctorj-wildfly82* is present in your registry.

  docker images

.. Execute tests (Start a container / Execute tests / Stop and destroy the container)

  mvn clean test -Pwildfly82

[[eg4-callouts]]
.Test executed with Maven
====
include::log_maven_build.txt[lines=5..10]
====

[IMPORTANT]
====
 Until the Docker image is present in your registry, you can just execute the Maven command (2b) !
====

===== All in one with Arquillian : Build the Docker image and execute tests in a container

. Clone this project :

 $ git clone https://github.com/mgreau/docker-asciidoctorj.git

. Ensure Java, Maven and Docker are installed
. Execute tests (Build a docker image / Start a container / Execute tests / Stop and destroy the container)

  mvn clean test -Pwildfly82_dockerfile

If you want to customize the container, you can update the dockerfile and re-lauch the Maven command

===== Convert AsciiDoc to PDF and HTML5

The tests are very basic for now, they will convert the same sample.adoc file to a PDF or to HTML.

== AsciidoctorJ in your favorite Java application server ?

It seems that the *JRuby* classloader problem is solve with the use of *JBoss Modules components*. +
However if you want to quickly test AsciidoctorJ in your favorite Java application server like TomEE or others...feel free to fork the project and quickly test if it works into
your favorite application server, here are the steps to follow :

 . Fork the GitHub repository {uri-docker-asciidoctorj-github}[docker-asciidoctorj]
 . Create a +Dockerfile+ file in a +dockerfiles+ subfolder, following the named convention +{appservername}{version}+
 . Update the +src/test/resources/arquillian.xml+ file to add a docker container
 . Update the +pom.xml+ to add Maven profiles related to the application server
 . Execute tests (maybe create a dedicated test) and see the results

If you do this steps, I'd love to have your feedbacks, so feel free to add a comment here, on the {discussion list) or on the GitHub project. +
We are waiting for PR :)

== Asciidoctor has its own official registry on Docker Hub

The good news here is that the Asciidoctor project now have an *easy way to test* if the future versions of *AsciidoctorJ will be compatible* with this architecture. +
But the most important thing is that Asciidoctor now has *+its own official registry for Docker images+*, with, for now, 2 officials images :

- asciidoctor _(created by {uri-twitter-guillaume-scheibel}[Guillaume Scheibel])_
- asciidoctor/asciidoctorj-wildfly82

And I'm so proud to be one of the Docker Hub administrator for the Asciidoctor Organization ! +

Have fun with *Asciidoctor*, *Arquillian* and *Docker* :)
